# 快速部署到 Google Cloud Run - 完成說明

## ✅ 已完成的設定

我已經為您的專案設定好所有部署到 Google Cloud Run 所需的檔案和配置：

### 1. 核心配置檔案

✅ **cloudbuild.yaml** - 自動化建置和部署配置
  - 自動安裝依賴
  - 自動建置前端
  - 自動建置 Docker 映像
  - 自動部署到 Cloud Run

✅ **.gcloudignore** - 指定不上傳的檔案（減少部署時間）

✅ **integrated-final/Dockerfile** - 已優化的 Docker 容器配置
  - 使用 Node.js 20
  - 生產環境最佳化
  - 自動設定環境變數

✅ **integrated-final/.dockerignore** - Docker 建置時忽略的檔案

### 2. 自動化腳本

✅ **deploy.sh** - 一鍵部署腳本
  - 自動設定 GCP 專案
  - 自動啟用必要的 API
  - 引導設定 API 金鑰
  - 執行建置和部署

✅ **test-build.sh** - 本地測試腳本
  - 驗證建置流程
  - 檢查必要檔案
  - 測試 Docker 建置

### 3. CI/CD 設定

✅ **.github/workflows/deploy-cloud-run.yml** - GitHub Actions 自動部署
  - 推送到 main 分支自動部署
  - 可手動觸發部署

### 4. 文件

✅ **DEPLOY_QUICKSTART.md** - 快速啟動指南（2 分鐘上手）
✅ **CLOUD_RUN_DEPLOYMENT.md** - 完整部署文件（詳細說明）
✅ **DEPLOYMENT_CHECKLIST.md** - 部署檢查清單
✅ **README.md** - 更新了部署資訊

## 🚀 如何使用

### 最簡單的方式（推薦）

只需要一個指令：

```bash
./deploy.sh YOUR_PROJECT_ID
```

腳本會引導您完成所有步驟！

### 手動部署

如果您想要更多控制，可以：

```bash
# 1. 設定專案
gcloud config set project YOUR_PROJECT_ID

# 2. 啟用 API
gcloud services enable cloudbuild.googleapis.com run.googleapis.com secretmanager.googleapis.com

# 3. 設定 API 金鑰
echo -n "YOUR_API_KEY" | gcloud secrets create GOOGLE_API_KEY --data-file=- --replication-policy="automatic"

# 4. 設定權限
PROJECT_NUMBER=$(gcloud projects describe YOUR_PROJECT_ID --format="value(projectNumber)")
gcloud secrets add-iam-policy-binding GOOGLE_API_KEY \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# 5. 部署
gcloud builds submit --config=cloudbuild.yaml
```

## 📋 前置需求

1. **Google Cloud SDK**
   ```bash
   # 檢查是否已安裝
   gcloud --version
   ```

2. **登入 Google Cloud**
   ```bash
   gcloud auth login
   ```

3. **Gemini API 金鑰**
   - 前往：https://makersuite.google.com/app/apikey
   - 建立並複製您的 API 金鑰

## 🎯 部署後的結果

部署成功後，您會獲得：

- ✅ 一個公開的服務 URL（例如：`https://autoline-xxxxx.a.run.app`）
- ✅ 自動擴展（無流量時不收費）
- ✅ HTTPS 加密
- ✅ 全球 CDN 加速
- ✅ 自動健康檢查

## 💡 設定說明

### 地區設定
預設使用 `asia-east1`（台灣），如需修改請編輯 `cloudbuild.yaml`：
```yaml
--region=asia-east1  # 可改為 us-central1, europe-west1 等
```

### 資源配置
預設配置（適合中小型應用）：
- 記憶體：1GB
- CPU：1 核心
- 最大實例：10
- 最小實例：0（無流量時不收費）

如需調整，編輯 `cloudbuild.yaml` 中的相關設定。

## 📊 成本預估

Cloud Run 免費額度（每月）：
- 200 萬次請求
- 360,000 GB-秒記憶體
- 180,000 vCPU-秒 CPU

對於小型到中型專案，通常完全免費或只需幾美元！

## 🔄 更新部署

當您有新的程式碼變更時：

```bash
# 使用腳本
./deploy.sh YOUR_PROJECT_ID

# 或直接用 gcloud
gcloud builds submit --config=cloudbuild.yaml
```

## 🤖 設定自動部署（GitHub Actions）

1. 建立服務帳號並產生金鑰
2. 在 GitHub 儲存庫設定中新增 Secrets：
   - `GCP_PROJECT_ID`：您的專案 ID
   - `GCP_SA_KEY`：服務帳號金鑰（JSON）
3. 推送到 main 分支時會自動部署

詳細步驟請參閱 `CLOUD_RUN_DEPLOYMENT.md`

## 🐛 故障排除

### 常見問題

**Q: 執行 deploy.sh 時出現權限錯誤**
A: 確認您的帳號有專案的編輯者權限

**Q: 建置失敗**
A: 查看建置日誌：
```bash
gcloud builds log $(gcloud builds list --limit=1 --format="value(id)")
```

**Q: 容器無法啟動**
A: 查看服務日誌：
```bash
gcloud run services logs tail autoline --region=asia-east1
```

**Q: API 金鑰錯誤**
A: 重新設定密鑰：
```bash
echo -n "YOUR_NEW_API_KEY" | gcloud secrets versions add GOOGLE_API_KEY --data-file=-
```

## 📚 詳細文件

- **快速開始**：`DEPLOY_QUICKSTART.md`
- **完整指南**：`CLOUD_RUN_DEPLOYMENT.md`
- **檢查清單**：`DEPLOYMENT_CHECKLIST.md`

## ✨ 總結

所有部署設定已經完成！您現在可以：

1. ✅ 使用 `./deploy.sh YOUR_PROJECT_ID` 一鍵部署
2. ✅ 或按照文件手動部署
3. ✅ 設定 GitHub Actions 實現自動部署
4. ✅ 使用 `test-build.sh` 在本地測試

**開始部署您的應用程式吧！** 🚀

---

**提示**：第一次部署可能需要 5-10 分鐘，請耐心等待。後續更新會更快！

**需要協助？** 請參閱詳細文件或檢查 GitHub Issues。
