name: Auto Update Dependencies

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 9:00 (UTC) åŸ·è¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: æ›´æ–°ä¾è³´å¥—ä»¶
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: integrated-final/package-lock.json

      - name: Check for outdated packages
        id: check-updates
        working-directory: integrated-final
        run: |
          echo "Checking for outdated packages..."
          npm outdated || true
          
          # æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ›´æ–°
          if npm outdated | grep -q .; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available!"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available."
          fi

      - name: Update dependencies
        if: steps.check-updates.outputs.has_updates == 'true'
        working-directory: integrated-final
        run: |
          # æ›´æ–°æ‰€æœ‰ patch å’Œ minor ç‰ˆæœ¬
          npm update
          
          # è¨˜éŒ„æ›´æ–°å…§å®¹
          git diff package.json package-lock.json > /tmp/update-diff.txt || true

      - name: Build and test
        if: steps.check-updates.outputs.has_updates == 'true'
        working-directory: integrated-final
        run: |
          npm ci
          npm run build

      - name: Create Pull Request
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ¤– è‡ªå‹•æ›´æ–°ä¾è³´å¥—ä»¶'
          title: 'ðŸ¤– è‡ªå‹•æ›´æ–°ä¾è³´å¥—ä»¶'
          body: |
            ## ðŸ“¦ ä¾è³´å¥—ä»¶è‡ªå‹•æ›´æ–°
            
            æ­¤ PR ç”±è‡ªå‹•åŒ–æµç¨‹å»ºç«‹ï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            
            ### æ›´æ–°å…§å®¹
            
            å·²åŸ·è¡Œ `npm update` æ›´æ–°æ‰€æœ‰ patch å’Œ minor ç‰ˆæœ¬çš„å¥—ä»¶ã€‚
            
            ### å»ºç½®ç‹€æ…‹
            
            âœ… æ‰€æœ‰ä¾è³´å·²æˆåŠŸå®‰è£
            âœ… å‰ç«¯å»ºç½®æˆåŠŸ
            
            ### æª¢æŸ¥æ¸…å–®
            
            - [ ] å¯©æŸ¥ package.json å’Œ package-lock.json çš„è®Šæ›´
            - [ ] ç¢ºèªæ²’æœ‰ç ´å£žæ€§è®Šæ›´
            - [ ] æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼åŠŸèƒ½
            - [ ] åˆä½µå¾Œå°‡è‡ªå‹•éƒ¨ç½²åˆ° Cloud Run
            
            ---
            
            ðŸ¤– æ­¤ PR ç”± Auto Update Dependencies workflow è‡ªå‹•å»ºç«‹
            ðŸ“… å»ºç«‹æ™‚é–“ï¼š${{ github.event.repository.updated_at }}
          branch: auto-update-dependencies
          delete-branch: true
          labels: |
            automated
            dependencies

      - name: Summary
        run: |
          if [ "${{ steps.check-updates.outputs.has_updates }}" == "true" ]; then
            echo "## ðŸ“¦ ä¾è³´å¥—ä»¶æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… å·²å»ºç«‹ PR åŒ…å«ä¾è³´å¥—ä»¶æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è«‹å‰å¾€ Pull Requests åˆ†é å¯©æŸ¥è®Šæ›´" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ¨ ä¾è³´å¥—ä»¶å·²æ˜¯æœ€æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å¥—ä»¶éƒ½å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œç„¡éœ€æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          fi
