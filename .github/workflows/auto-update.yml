name: Auto Update Dependencies

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 9:00 (UTC) åŸ·è¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: integrated-final/package-lock.json

      - name: Check for outdated packages
        working-directory: integrated-final
        id: check-updates
        run: |
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "## ğŸ“¦ å¯æ›´æ–°çš„å¥—ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat outdated.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "## âœ… æ‰€æœ‰å¥—ä»¶éƒ½æ˜¯æœ€æ–°çš„" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update dependencies
        if: steps.check-updates.outputs.has_updates == 'true'
        working-directory: integrated-final
        run: |
          # æ›´æ–° patch å’Œ minor ç‰ˆæœ¬ï¼ˆå®‰å…¨æ›´æ–°ï¼‰
          npm update
          
          # è¨˜éŒ„æ›´æ–°å…§å®¹
          git diff package.json package-lock.json > updates.diff || true

      - name: Run tests after update
        if: steps.check-updates.outputs.has_updates == 'true'
        working-directory: integrated-final
        run: |
          npm ci
          npm run build

      - name: Create Pull Request
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ğŸ¤– è‡ªå‹•æ›´æ–°ä¾è³´å¥—ä»¶'
          body: |
            ## è‡ªå‹•æ›´æ–°ä¾è³´å¥—ä»¶
            
            æ­¤ PR ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            
            ### æ›´æ–°å…§å®¹
            - å·²åŸ·è¡Œ `npm update` æ›´æ–° patch å’Œ minor ç‰ˆæœ¬
            - å·²é€šéå»ºç½®æ¸¬è©¦
            
            ### æª¢æŸ¥æ¸…å–®
            - [x] ä¾è³´å¥—ä»¶å·²æ›´æ–°
            - [x] å»ºç½®æˆåŠŸ
            - [ ] éœ€è¦äººå·¥å¯©æŸ¥å’Œæ¸¬è©¦
            
            ### ä¸‹ä¸€æ­¥
            1. å¯©æŸ¥è®Šæ›´å…§å®¹
            2. æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼åŠŸèƒ½
            3. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆä½µæ­¤ PR
            
            ---
            
            ğŸ¤– æ­¤ PR ç”±è‡ªå‹•åŒ–æµç¨‹å»ºç«‹
          branch: auto-update-dependencies
          delete-branch: true
          labels: dependencies, automated

      - name: No updates needed
        if: steps.check-updates.outputs.has_updates == 'false'
        run: |
          echo "âœ… æ‰€æœ‰ä¾è³´å¥—ä»¶éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œç„¡éœ€æ›´æ–°"
