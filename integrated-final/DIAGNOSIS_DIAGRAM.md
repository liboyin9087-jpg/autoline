# å‰å¾Œç«¯é€£ç·šå•é¡Œè¨ºæ–·åœ–è§£

## å•é¡Œè¨ºæ–·æµç¨‹åœ–

```
ç”¨æˆ¶åé¥‹ï¼šå‰å¾Œç«¯é€£ç·šä¸ä¸Š
         â†“
    é–‹å§‹è¨ºæ–·
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æª¢æŸ¥ .env    â”‚ â†’ âŒ ä¸å­˜åœ¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æª¢æŸ¥ dist/   â”‚ â†’ âŒ æœªå»ºç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å˜—è©¦å»ºç½®     â”‚ â†’ âŒ çµ„ä»¶ç¼ºå¤±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æª¢æŸ¥ API     â”‚ â†’ ğŸ”´ æ ¼å¼ä¸åŒ¹é…ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    æ‰¾åˆ°æ ¹æœ¬åŸå› 
```

## API æ ¼å¼ä¸åŒ¹é…è©³è§£

### ä¿®å¾©å‰çš„å•é¡Œ

```javascript
// å‰ç«¯ (geminiService.ts) ç™¼é€è«‹æ±‚
await fetch('/api/chat', {
  body: JSON.stringify({
    contents: [...],
    systemInstruction: "...",
    maxOutputTokens: 2048
  })
})

// å‰ç«¯æœŸå¾…æ”¶åˆ°
{
  text: "AI çš„å›æ‡‰å…§å®¹",  â† æœŸå¾…é€™å€‹å±¬æ€§
  usage: { ... }
}

// å¾Œç«¯ (server.js) å¯¦éš›å›æ‡‰
{
  reply: "AI çš„å›æ‡‰å…§å®¹",  â† ä½†å¯¦éš›æ˜¯é€™å€‹å±¬æ€§
  usage: { ... }
}

// å‰ç«¯å˜—è©¦è®€å– res.text
const responseText = res.text;  // undefined!
                                // å› ç‚ºå¾Œç«¯è¿”å›çš„æ˜¯ res.reply

// çµæœï¼šå‰ç«¯ç„¡æ³•å–å¾—å›æ‡‰ï¼Œé¡¯ç¤ºã€Œé€£ç·šå¤±æ•—ã€
```

### ä¿®å¾©å¾Œçš„æ­£ç¢ºæµç¨‹

```javascript
// å¾Œç«¯ (server.js) - å·²ä¿®å¾©
res.json({
  text: text,  // âœ… æ”¹ç‚º text
  usage
})

// å‰ç«¯å¯ä»¥æ­£ç¢ºè®€å–
const responseText = res.text;  // âœ… æˆåŠŸå–å¾—å›æ‡‰ï¼
```

## å®Œæ•´çš„ API è³‡æ–™æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ä»‹é¢                             â”‚
â”‚  ç”¨æˆ¶è¼¸å…¥ï¼šã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            geminiService.ts (å‰ç«¯æœå‹™)                   â”‚
â”‚  buildContents([...messages])                           â”‚
â”‚  æº–å‚™è«‹æ±‚ï¼š                                              â”‚
â”‚  {                                                       â”‚
â”‚    contents: [                                           â”‚
â”‚      { role: 'user', parts: [{ text: 'ä»Šå¤©å¤©æ°£...' }] }â”‚
â”‚    ],                                                    â”‚
â”‚    systemInstruction: "ä½ æ˜¯æ™ºæ…§ä»™å§‘...",                â”‚
â”‚    maxOutputTokens: 2048                                 â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ POST /api/chat
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Vite Dev Server (localhost:5173)                â”‚
â”‚         Proxy: /api/* â†’ localhost:8080                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Express Server (localhost:8080)                 â”‚
â”‚  app.post('/api/chat', async (req, res) => {            â”‚
â”‚    const { contents, systemInstruction, maxTokens } = req.body; â”‚
â”‚    âœ… é©—è­‰è«‹æ±‚æ ¼å¼                                       â”‚
â”‚    âœ… æª¢æŸ¥ API Key                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ å‘¼å« Gemini API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Google Gemini API                             â”‚
â”‚  https://generativelanguage.googleapis.com/...          â”‚
â”‚  è™•ç†è«‹æ±‚ä¸¦ç”Ÿæˆå›æ‡‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è¿”å› JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Express Server è™•ç†å›æ‡‰                          â”‚
â”‚  const text = data.candidates[0].content.parts[0].text; â”‚
â”‚  const usage = data.usageMetadata;                      â”‚
â”‚                                                          â”‚
â”‚  âœ… ä¿®å¾©å‰ï¼šres.json({ reply: text, usage });           â”‚
â”‚  âœ… ä¿®å¾©å¾Œï¼šres.json({ text, usage });                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è¿”å› { text, usage }
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         geminiService.ts æ¥æ”¶å›æ‡‰                        â”‚
â”‚  const res = await response.json();                     â”‚
â”‚  return res;  // { text: "...", usage: {...} }          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              App.tsx è™•ç†å›æ‡‰                            â”‚
â”‚  const res = await sendMessageToGemini(...);            â”‚
â”‚  responseText = res.text;  // âœ… æˆåŠŸå–å¾—ï¼             â”‚
â”‚  usage = res.usage;                                      â”‚
â”‚                                                          â”‚
â”‚  setMessages([...messages, {                            â”‚
â”‚    role: 'model',                                        â”‚
â”‚    text: responseText  // é¡¯ç¤ºåœ¨ä»‹é¢ä¸Š                  â”‚
â”‚  }])                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ä»‹é¢                              â”‚
â”‚  ğŸ’¬ æ™ºæ…§ä»™å§‘ï¼šã€Œä¾æˆ‘çœ‹ï¼Œä»Šå¤©å¤©æ°£æ™´æœ—ï¼Œé©åˆå‡ºé–€...ã€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å°ˆæ¡ˆçµæ§‹å•é¡Œ

### ä¿®å¾©å‰

```
integrated-final/
â”œâ”€â”€ components/          â† å®Œæ•´çš„çµ„ä»¶åœ¨é€™è£¡
â”‚   â”œâ”€â”€ Toast.tsx
â”‚   â”œâ”€â”€ DivineFortune.tsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.tsx          â† ä½† App.tsx å¾é€™è£¡ import
â”‚   â””â”€â”€ components/      â† é€™è£¡åªæœ‰éƒ¨åˆ†çµ„ä»¶
â”‚       â”œâ”€â”€ Header.tsx
â”‚       â””â”€â”€ ...
â””â”€â”€ vite.config.ts       â† Vite åªå»ºç½® src/ ç›®éŒ„

çµæœï¼šnpm run build å¤±æ•— âŒ
æ‰¾ä¸åˆ° ./components/Toast
æ‰¾ä¸åˆ° ./services/geminiService
```

### ä¿®å¾©å¾Œ

```
integrated-final/
â”œâ”€â”€ components/          â† ä¿ç•™åŸå§‹çµ„ä»¶ï¼ˆåƒè€ƒç”¨ï¼‰
â”œâ”€â”€ src/                 â† çµ±ä¸€ä½¿ç”¨ src/ ç›®éŒ„
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ types.ts         â† å®Œæ•´çš„é¡å‹å®šç¾©
â”‚   â”œâ”€â”€ components/      â† æ‰€æœ‰çµ„ä»¶éƒ½åœ¨é€™è£¡
â”‚   â”‚   â”œâ”€â”€ Toast.tsx
â”‚   â”‚   â”œâ”€â”€ DivineFortune.tsx
â”‚   â”‚   â””â”€â”€ ... (å…± 18 å€‹æª”æ¡ˆ)
â”‚   â”œâ”€â”€ services/        â† API æœå‹™
â”‚   â”‚   â””â”€â”€ geminiService.ts
â”‚   â””â”€â”€ utils/           â† å·¥å…·å‡½æ•¸
â”‚       â””â”€â”€ parser.ts
â””â”€â”€ vite.config.ts       â† Vite å»ºç½® src/ ç›®éŒ„

çµæœï¼šnpm run build æˆåŠŸ âœ…
æ‰€æœ‰çµ„ä»¶éƒ½èƒ½æ­£ç¢ºå¼•å…¥
```

## ä¿®å¾©æ™‚é–“è»¸

```
2025-12-08 14:17 â†’ é–‹å§‹è¨ºæ–·
              â†“
         14:20 â†’ ç™¼ç¾ API æ ¼å¼ä¸åŒ¹é…
              â†“
         14:21 â†’ ä¿®å¾© server.js (reply â†’ text)
              â†“
         14:22 â†’ ç™¼ç¾çµ„ä»¶ç¼ºå¤±å•é¡Œ
              â†“
         14:22 â†’ è¤‡è£½æ‰€æœ‰çµ„ä»¶åˆ° src/
              â†“
         14:22 â†’ npm run build æˆåŠŸï¼
              â†“
         14:23 â†’ æ¸¬è©¦ä¼ºæœå™¨å•Ÿå‹• - æˆåŠŸ
              â†“
         14:24 â†’ å¥åº·æª¢æŸ¥æ­£å¸¸
              â†“
         14:25 â†’ å®Œæˆæ–‡ä»¶æ’°å¯«
              â†“
         14:26 â†’ ç¨‹å¼ç¢¼å¯©æŸ¥é€šé
              â†“
         14:26 â†’ å®‰å…¨æ€§æƒæé€šé
              â†“
         14:27 â†’ âœ… ä¿®å¾©å®Œæˆï¼
```

## é—œéµä¿®å¾©å°æ¯”

| é …ç›® | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ |
|------|--------|--------|
| API å›æ‡‰å±¬æ€§ | `reply` âŒ | `text` âœ… |
| çµ„ä»¶ä½ç½® | æ•£è½å…©è™• âŒ | çµ±ä¸€ src/ âœ… |
| types.ts | ä¸å®Œæ•´ âŒ | å®Œæ•´å®šç¾© âœ… |
| å»ºç½®ç‹€æ…‹ | å¤±æ•— âŒ | æˆåŠŸ âœ… |
| ä¼ºæœå™¨å•Ÿå‹• | - | æ­£å¸¸ âœ… |
| å¥åº·æª¢æŸ¥ | - | æ­£å¸¸ âœ… |
| æ–‡ä»¶ | ä¸å®Œæ•´ | å®Œæ•´ âœ… |

## é©—è­‰æ–¹æ³•

### 1. æª¢æŸ¥ API æ ¼å¼

```bash
# å•Ÿå‹•ä¼ºæœå™¨
cd integrated-final
node server.js &

# ç­‰å¾… 3 ç§’
sleep 3

# ç™¼é€æ¸¬è©¦è«‹æ±‚ï¼ˆéœ€è¦çœŸå¯¦ API Keyï¼‰
curl -X POST http://localhost:8080/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "contents": [{"role":"user","parts":[{"text":"æ¸¬è©¦"}]}],
    "systemInstruction": "ç°¡çŸ­å›ç­”",
    "maxOutputTokens": 100
  }'

# é æœŸå›æ‡‰æ ¼å¼
{
  "text": "AI å›æ‡‰å…§å®¹",  â† ç¢ºèªæ˜¯ text ä¸æ˜¯ reply
  "usage": { ... }
}
```

### 2. æª¢æŸ¥å»ºç½®

```bash
cd integrated-final
npm run build

# é æœŸè¼¸å‡º
âœ“ 1479 modules transformed.
rendering chunks...
âœ“ built in 2.79s

# æª¢æŸ¥ç”¢ç‰©
ls -lh dist/
# æ‡‰è©²çœ‹åˆ° index.html å’Œ assets/
```

### 3. æª¢æŸ¥çµ„ä»¶

```bash
# ç¢ºèªæ‰€æœ‰çµ„ä»¶éƒ½å­˜åœ¨
ls src/components/
# æ‡‰è©²çœ‹åˆ° 18 å€‹ .tsx æª”æ¡ˆ

ls src/services/
# æ‡‰è©²çœ‹åˆ° geminiService.ts

ls src/utils/
# æ‡‰è©²çœ‹åˆ° parser.ts
```

## ç¸½çµ

```
å•é¡Œæ ¹æºï¼šAPI å›æ‡‰æ ¼å¼ä¸åŒ¹é…
         â†“
     ä¿®å¾©æ–¹å¼ï¼š
  1. æ”¹ reply â†’ text
  2. çµ±ä¸€å°ˆæ¡ˆçµæ§‹
  3. å»ºç«‹å®Œæ•´æ–‡ä»¶
         â†“
     é©—è­‰çµæœï¼š
  âœ… å»ºç½®æˆåŠŸ
  âœ… ä¼ºæœå™¨æ­£å¸¸
  âœ… å¯©æŸ¥é€šé
         â†“
    ğŸ‰ ä¿®å¾©å®Œæˆï¼
```

éœ€è¦çœŸå¯¦ Google API Key æ‰èƒ½é€²è¡Œå®Œæ•´çš„åŠŸèƒ½æ¸¬è©¦ã€‚
